{"version":3,"file":"smartlink_actions.min.js","sources":["../src/smartlink_actions.js"],"sourcesContent":["import $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport * as Str from 'core/str';\n\nclass SmartLinkActions {\n\n    constructor(courseid, instanceid, moduleid) {\n        this.prompts = [];\n        this.courseid = courseid;\n        this.instanceid = instanceid;\n        this.moduleid = moduleid;\n        this.contextid = 1;\n        this.init();\n    }\n\n    getPrompts() {\n        Ajax.call([\n            {\n                methodname: \"mod_smartlink_get_available_prompts\",\n                args: {},\n                done: this.handlePrompts.bind(this),\n                fail: this.handleFailure.bind(this),\n            },\n        ]);\n    }\n\n    handlePrompts(response) {\n        let responseData = JSON.parse(response);\n        let prompts = responseData.data || {};\n        this.prompts = Object.values(prompts);\n    }\n\n    init() {\n        this.getPrompts();\n\n        $(\".modal\").on(\"hidden.bs.modal\", function () {\n            $('form[name=\"custom-prompt-form\"]')[0].reset();\n        });\n\n        $(\"[data-dismiss='modal']\").on(\"click\", function () {\n            $('form[name=\"custom-prompt-form\"]')[0].reset();\n        });\n\n        // Click outside modal\n        $(document).click(async function (e) {\n            if (e.target.id === \"ownPromptModal\") {\n                var confimationMsg = await Str.get_string(\"prompt_modal_close_warning\", \"smartlink\");\n                if (confirm(confimationMsg)) {\n                    $(\".custom-prompt-modal\").modal(\"toggle\");\n                }\n            } else if (e.target.id === \"responseModal\") {\n                var confimationMsg = await Str.get_string(\"response_modal_close_warning\", \"smartlink\");\n                if (confirm(confimationMsg)) {\n                    $(\".response-modal\").modal(\"toggle\");\n                }\n            }\n        });\n\n        // Prompt from list\n        $('.smartlink[data-id=\"'+this.moduleid+'\"] .run-prompt-btn').click(function (e) {\n            e.preventDefault();\n            let promptId = $(e.target).data('id');\n            let promptSetting = this.prompts.find((prompt) => prompt.id == promptId);\n            if (promptSetting && !this.siblingsLoading()) {\n                this.getAiResponse({\n                    promptid: promptSetting.id,\n                    courseid: this.courseid,\n                    instanceid: this.instanceid\n                });\n            }\n        }.bind(this));\n\n        // Prompt from input\n        $('#ownPromptModal[data-moduleid=\"'+this.moduleid+'\"] .submit-own-prompt-btn').click(function (e) {\n            e.preventDefault();\n            let prompt = $('#ownPromptModal[data-moduleid=\"'+this.moduleid+'\"] textarea[name=\"prompt\"]').val();\n            if (prompt && !this.siblingsLoading()) {\n                this.getAiResponse({\n                    prompt: prompt,\n                    courseid: this.courseid,\n                    instanceid: this.instanceid\n                });\n            }\n        }.bind(this));\n    }\n\n    siblingsLoading() {\n        let loading = false;\n        document.querySelectorAll('.smartlink .spinner').forEach(function(spinner) {\n            if (!spinner.classList.contains('d-none')) {\n                loading = true;\n            }\n        });\n        return loading;\n    }\n\n    getAiResponse(promptdata) {\n        $('.smartlink[data-id=\"'+this.moduleid+'\"] .spinner').removeClass(\"d-none\");\n        Ajax.call([\n            {\n                methodname: \"mod_smartlink_prompt_openai\",\n                args: { contextid: this.contextid, jsondata: JSON.stringify(promptdata) },\n                done: this.handleResponse.bind(this),\n                fail: this.handleFailure.bind(this),\n            },\n        ]);\n    }\n\n    // On a succesful response\n    handleResponse(response) {\n        $('.smartlink[data-id=\"'+this.moduleid+'\"] .spinner').addClass(\"d-none\");\n        let responseObj = JSON.parse(response);\n        let modal = $('#ownPromptModal[data-moduleid=\"'+this.moduleid+'\"]');\n\n        if (modal.is(':visible')) {\n            modal.modal('toggle');\n        }\n\n        // Might contain errors anyway\n        if (responseObj.success == false) {\n            alert(responseObj.message);\n        } else {\n            let data = responseObj.data;\n            let result = data.result || 'No response from AI';\n            $(\".prompt-desc\").html(data.description || '');\n            $(\".prompt-text\").html(data.prompt_text || '');\n            $(\".ai-response\").html(result.replace(/\\n/g, '<br/>'));\n            $(\"#responseModal\").modal(\"toggle\");\n        }\n    }\n\n    // Failure\n    handleFailure(response) {\n        $('.smartlink[data-id=\"'+this.moduleid+'\"] .spinner').addClass(\"d-none\");\n        var responseObj = JSON.parse(response);\n        alert(responseObj.message);\n    }\n}\n\nexport const init = (courseid, instanceid, moduleid) => {\n    return new SmartLinkActions(courseid, instanceid, moduleid);\n};\n"],"names":["SmartLinkActions","constructor","courseid","instanceid","moduleid","prompts","contextid","init","getPrompts","call","methodname","args","done","this","handlePrompts","bind","fail","handleFailure","response","JSON","parse","data","Object","values","on","reset","document","click","async","e","target","id","confimationMsg","Str","get_string","confirm","modal","preventDefault","promptId","promptSetting","find","prompt","siblingsLoading","getAiResponse","promptid","val","loading","querySelectorAll","forEach","spinner","classList","contains","promptdata","removeClass","jsondata","stringify","handleResponse","addClass","responseObj","is","success","alert","message","result","html","description","prompt_text","replace"],"mappings":"qxCAIMA,iBAEFC,YAAYC,SAAUC,WAAYC,eACzBC,QAAU,QACVH,SAAWA,cACXC,WAAaA,gBACbC,SAAWA,cACXE,UAAY,OACZC,OAGTC,2BACSC,KAAK,CACN,CACIC,WAAY,sCACZC,KAAM,GACNC,KAAMC,KAAKC,cAAcC,KAAKF,MAC9BG,KAAMH,KAAKI,cAAcF,KAAKF,SAK1CC,cAAcI,cAENb,QADec,KAAKC,MAAMF,UACHG,MAAQ,QAC9BhB,QAAUiB,OAAOC,OAAOlB,SAGjCE,YACSC,iCAEH,UAAUgB,GAAG,mBAAmB,+BAC5B,mCAAmC,GAAGC,+BAG1C,0BAA0BD,GAAG,SAAS,+BAClC,mCAAmC,GAAGC,+BAI1CC,UAAUC,OAAMC,eAAgBC,MACV,mBAAhBA,EAAEC,OAAOC,GAAyB,KAC9BC,qBAAuBC,IAAIC,WAAW,6BAA8B,aACpEC,QAAQH,qCACN,wBAAwBI,MAAM,eAEjC,GAAoB,kBAAhBP,EAAEC,OAAOC,GAAwB,CACpCC,qBAAuBC,IAAIC,WAAW,+BAAgC,aACtEC,QAAQH,qCACN,mBAAmBI,MAAM,kCAMrC,uBAAuBvB,KAAKT,SAAS,sBAAsBuB,MAAM,SAAUE,GACzEA,EAAEQ,qBACEC,UAAW,mBAAET,EAAEC,QAAQT,KAAK,MAC5BkB,cAAgB1B,KAAKR,QAAQmC,MAAMC,QAAWA,OAAOV,IAAMO,WAC3DC,gBAAkB1B,KAAK6B,wBAClBC,cAAc,CACfC,SAAUL,cAAcR,GACxB7B,SAAUW,KAAKX,SACfC,WAAYU,KAAKV,cAG3BY,KAAKF,2BAGL,kCAAkCA,KAAKT,SAAS,6BAA6BuB,MAAM,SAAUE,GAC3FA,EAAEQ,qBACEI,QAAS,mBAAE,kCAAkC5B,KAAKT,SAAS,8BAA8ByC,MACzFJ,SAAW5B,KAAK6B,wBACXC,cAAc,CACfF,OAAQA,OACRvC,SAAUW,KAAKX,SACfC,WAAYU,KAAKV,cAG3BY,KAAKF,OAGX6B,sBACQI,SAAU,SACdpB,SAASqB,iBAAiB,uBAAuBC,SAAQ,SAASC,SACzDA,QAAQC,UAAUC,SAAS,YAC5BL,SAAU,MAGXA,QAGXH,cAAcS,gCACR,uBAAuBvC,KAAKT,SAAS,eAAeiD,YAAY,wBAC7D5C,KAAK,CACN,CACIC,WAAY,8BACZC,KAAM,CAAEL,UAAWO,KAAKP,UAAWgD,SAAUnC,KAAKoC,UAAUH,aAC5DxC,KAAMC,KAAK2C,eAAezC,KAAKF,MAC/BG,KAAMH,KAAKI,cAAcF,KAAKF,SAM1C2C,eAAetC,8BACT,uBAAuBL,KAAKT,SAAS,eAAeqD,SAAS,cAC3DC,YAAcvC,KAAKC,MAAMF,UACzBkB,OAAQ,mBAAE,kCAAkCvB,KAAKT,SAAS,SAE1DgC,MAAMuB,GAAG,aACTvB,MAAMA,MAAM,UAIW,GAAvBsB,YAAYE,QACZC,MAAMH,YAAYI,aACf,KACCzC,KAAOqC,YAAYrC,KACnB0C,OAAS1C,KAAK0C,QAAU,0CAC1B,gBAAgBC,KAAK3C,KAAK4C,aAAe,wBACzC,gBAAgBD,KAAK3C,KAAK6C,aAAe,wBACzC,gBAAgBF,KAAKD,OAAOI,QAAQ,MAAO,8BAC3C,kBAAkB/B,MAAM,WAKlCnB,cAAcC,8BACR,uBAAuBL,KAAKT,SAAS,eAAeqD,SAAS,cAC3DC,YAAcvC,KAAKC,MAAMF,UAC7B2C,MAAMH,YAAYI,wBAIN,CAAC5D,SAAUC,WAAYC,WAChC,IAAIJ,iBAAiBE,SAAUC,WAAYC"}