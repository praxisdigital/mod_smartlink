{"version":3,"file":"smartlink_actions.min.js","sources":["../src/smartlink_actions.js"],"sourcesContent":["import $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport * as Str from 'core/str';\n\nclass SmartLinkActions {\n\n    constructor(courseid, instanceid) {\n        this.prompts = [];\n        this.courseid = courseid;\n        this.instanceid = instanceid;\n        this.contextid = 1;\n        this.init();\n    }\n\n    getPrompts() {\n        Ajax.call([\n            {\n                methodname: \"mod_smartlink_get_available_prompts\",\n                args: {},\n                done: this.handlePrompts.bind(this),\n                fail: this.handleFailure.bind(this),\n            },\n        ]);\n    }\n\n    handlePrompts(response) {\n        let responseData = JSON.parse(response);\n        let prompts = responseData.data || {};\n        this.prompts = Object.values(prompts);\n    }\n\n    init() {\n        this.getPrompts();\n\n        $(\".modal\").on(\"hidden.bs.modal\", function () {\n            $('form[name=\"custom-prompt-form\"]')[0].reset();\n        });\n\n        $(\"[data-dismiss='modal']\").on(\"click\", function () {\n            $('form[name=\"custom-prompt-form\"]')[0].reset();\n        });\n\n        //handle modal outside click confirmation\n        $(document).click(async function (e) {\n            if (e.target.id === \"ownPromptModal\") {\n                var confimationMsg = await Str.get_string(\"prompt_modal_close_warning\", \"smartlink\");\n                if (confirm(confimationMsg)) {\n                    $(\".custom-prompt-modal\").modal(\"toggle\");\n                }\n            } else if (e.target.id === \"responseModal\") {\n                var confimationMsg = await Str.get_string(\"response_modal_close_warning\", \"smartlink\");\n                if (confirm(confimationMsg)) {\n                    $(\".response-modal\").modal(\"toggle\");\n                }\n            }\n        });\n\n        $(\".run-prompt-btn\").click(\n            function (e) {\n                e.preventDefault();\n                var attrVal = $(e.currentTarget).attr(\"data-id\");\n                var promptSetting = this.prompts.find((prompt) => prompt.id == attrVal);\n                if (promptSetting) {\n                    this.getAiResponse({ promptid: promptSetting.id, courseid: this.courseid, instanceid: this.instanceid });\n                }\n            }.bind(this)\n        );\n        $(\".submit-own-prompt-btn\").click(\n            function (e) {\n                e.preventDefault();\n                var promptVal = $(\"textarea[name='prompt']\").val();\n                this.getAiResponse({ prompt: promptVal, courseid: this.courseid, instanceid: this.instanceid });\n            }.bind(this)\n        );\n    }\n\n    getAiResponse(promptdata) {\n        $(\"#loader\").removeClass(\"d-none\");\n        Ajax.call([\n            {\n                methodname: \"mod_smartlink_prompt_openai\",\n                args: { contextid: this.contextid, jsondata: JSON.stringify(promptdata) },\n                done: this.handleResponse.bind(this),\n                fail: this.handleFailure.bind(this),\n            },\n        ]);\n    }\n\n    // On a succesful response\n    handleResponse(response) {\n        $(\"#loader\").addClass(\"d-none\");\n        var responseObj = JSON.parse(response);\n\n        if ($(\"#ownPromptModal\").is(\":visible\")) {\n            $(\"#ownPromptModal\").modal(\"toggle\");\n        }\n\n        // Might contain errors anyway\n        if (responseObj.success == false) {\n            alert(responseObj.message);\n        } else {\n            let data = responseObj.data;\n            let result = data.result || 'No response from AI';\n            $(\".prompt-desc\").html(data.description || '');\n            $(\".prompt-text\").html(data.prompt_text || '');\n            $(\".ai-response\").html(result.replace(/\\n/g, '<br/>'));\n            $(\"#responseModal\").modal(\"toggle\");\n        }\n    }\n\n    // Failure\n    handleFailure(response) {\n        $(\"#loader\").addClass(\"d-none\");\n        var responseObj = JSON.parse(response);\n        alert(responseObj.message);\n    }\n}\n\nexport const init = (courseid, instanceid) => {\n    return new SmartLinkActions(courseid, instanceid);\n};\n"],"names":["SmartLinkActions","constructor","courseid","instanceid","prompts","contextid","init","getPrompts","call","methodname","args","done","this","handlePrompts","bind","fail","handleFailure","response","JSON","parse","data","Object","values","on","reset","document","click","async","e","target","id","confimationMsg","Str","get_string","confirm","modal","preventDefault","attrVal","currentTarget","attr","promptSetting","find","prompt","getAiResponse","promptid","promptVal","val","promptdata","removeClass","jsondata","stringify","handleResponse","addClass","responseObj","is","success","alert","message","result","html","description","prompt_text","replace"],"mappings":"qxCAIMA,iBAEFC,YAAYC,SAAUC,iBACbC,QAAU,QACVF,SAAWA,cACXC,WAAaA,gBACbE,UAAY,OACZC,OAGTC,2BACSC,KAAK,CACN,CACIC,WAAY,sCACZC,KAAM,GACNC,KAAMC,KAAKC,cAAcC,KAAKF,MAC9BG,KAAMH,KAAKI,cAAcF,KAAKF,SAK1CC,cAAcI,cAENb,QADec,KAAKC,MAAMF,UACHG,MAAQ,QAC9BhB,QAAUiB,OAAOC,OAAOlB,SAGjCE,YACSC,iCAEH,UAAUgB,GAAG,mBAAmB,+BAC5B,mCAAmC,GAAGC,+BAG1C,0BAA0BD,GAAG,SAAS,+BAClC,mCAAmC,GAAGC,+BAI1CC,UAAUC,OAAMC,eAAgBC,MACV,mBAAhBA,EAAEC,OAAOC,GAAyB,KAC9BC,qBAAuBC,IAAIC,WAAW,6BAA8B,aACpEC,QAAQH,qCACN,wBAAwBI,MAAM,eAEjC,GAAoB,kBAAhBP,EAAEC,OAAOC,GAAwB,CACpCC,qBAAuBC,IAAIC,WAAW,+BAAgC,aACtEC,QAAQH,qCACN,mBAAmBI,MAAM,kCAKrC,mBAAmBT,MACjB,SAAUE,GACNA,EAAEQ,qBACEC,SAAU,mBAAET,EAAEU,eAAeC,KAAK,WAClCC,cAAgB5B,KAAKR,QAAQqC,MAAMC,QAAWA,OAAOZ,IAAMO,UAC3DG,oBACKG,cAAc,CAAEC,SAAUJ,cAAcV,GAAI5B,SAAUU,KAAKV,SAAUC,WAAYS,KAAKT,cAEjGW,KAAKF,2BAET,0BAA0Bc,MACxB,SAAUE,GACNA,EAAEQ,qBACES,WAAY,mBAAE,2BAA2BC,WACxCH,cAAc,CAAED,OAAQG,UAAW3C,SAAUU,KAAKV,SAAUC,WAAYS,KAAKT,cACpFW,KAAKF,OAIf+B,cAAcI,gCACR,WAAWC,YAAY,wBACpBxC,KAAK,CACN,CACIC,WAAY,8BACZC,KAAM,CAAEL,UAAWO,KAAKP,UAAW4C,SAAU/B,KAAKgC,UAAUH,aAC5DpC,KAAMC,KAAKuC,eAAerC,KAAKF,MAC/BG,KAAMH,KAAKI,cAAcF,KAAKF,SAM1CuC,eAAelC,8BACT,WAAWmC,SAAS,cAClBC,YAAcnC,KAAKC,MAAMF,cAEzB,mBAAE,mBAAmBqC,GAAG,iCACtB,mBAAmBnB,MAAM,UAIJ,GAAvBkB,YAAYE,QACZC,MAAMH,YAAYI,aACf,KACCrC,KAAOiC,YAAYjC,KACnBsC,OAAStC,KAAKsC,QAAU,0CAC1B,gBAAgBC,KAAKvC,KAAKwC,aAAe,wBACzC,gBAAgBD,KAAKvC,KAAKyC,aAAe,wBACzC,gBAAgBF,KAAKD,OAAOI,QAAQ,MAAO,8BAC3C,kBAAkB3B,MAAM,WAKlCnB,cAAcC,8BACR,WAAWmC,SAAS,cAClBC,YAAcnC,KAAKC,MAAMF,UAC7BuC,MAAMH,YAAYI,wBAIN,CAACvD,SAAUC,aACpB,IAAIH,iBAAiBE,SAAUC"}